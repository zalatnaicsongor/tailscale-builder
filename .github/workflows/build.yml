name: Build Tailscale combined static-ish binary (amd64, latest release)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 3 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Get latest release tag (stable, not prerelease)
      - name: Determine latest Tailscale release tag
        run: |
          API_URL="https://api.github.com/repos/tailscale/tailscale/releases/latest"
          TAG=$(curl -sSL "$API_URL" | jq -r '.tag_name')

          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "Failed to determine latest Tailscale release tag"
            exit 1
          fi

          echo "Latest Tailscale tag: $TAG"
          echo "TS_TAG=$TAG" >> "$GITHUB_ENV"

      # Checkout tailscale/tailscale into the *current working dir*
      # (no 'path' set => uses $GITHUB_WORKSPACE directly)
      - name: Checkout tailscale/tailscale at that tag
        uses: actions/checkout@v6
        with:
          repository: tailscale/tailscale
          ref: ${{ env.TS_TAG }}

      - name: Record build info
        run: |
          {
            echo "Tailscale tag: $TS_TAG"
            echo -n "Commit: "
            git rev-parse HEAD
          } > build-info.txt

      - name: Set up Go (match Tailscale's go.mod)
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Build combined multicall tailscale via build_dist.sh
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          chmod +x ./build_dist.sh

          # Smaller embedded-style binary + CLI included in tailscaled
          ./build_dist.sh --extra-small \
            -o tailscale.combined \
            -tags ts_include_cli \
            ./cmd/tailscaled

          echo "Built binary:"
          ls -lh tailscale.combined || true

          echo
          echo "ldd output (may fail or say 'not a dynamic executable' for static binaries):"
          ldd tailscale.combined || echo "ldd failed (likely due to static binary)"

          tar czf tailscale-linux-amd64-combined.tar.gz tailscale.combined

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-linux-amd64-combined
          path: |
            tailscale-linux-amd64-combined.tar.gz
            build-info.txt
